"use strict";(()=>{var I=["google.com","google.ac","google.ad","google.ae","google.al","google.am","google.as","google.at","google.az","google.ba","google.be","google.bf","google.bg","google.bi","google.bj","google.bs","google.bt","google.by","google.ca","google.cat","google.cc","google.cd","google.cf","google.cg","google.ch","google.ci","google.cl","google.cm","google.cn","google.co","google.co.ao","google.co.bw","google.co.ck","google.co.cr","google.co.id","google.co.il","google.co.in","google.co.jp","google.co.ke","google.co.kr","google.co.ls","google.co.ma","google.co.mz","google.co.nz","google.co.th","google.co.tz","google.co.ug","google.co.uk","google.co.uz","google.co.ve","google.co.vi","google.co.za","google.co.zm","google.co.zw","google.com.af","google.com.ag","google.com.ai","google.com.ar","google.com.au","google.com.bd","google.com.bh","google.com.bn","google.com.bo","google.com.br","google.com.bz","google.com.co","google.com.cu","google.com.cy","google.com.do","google.com.ec","google.com.eg","google.com.et","google.com.fj","google.com.gh","google.com.gi","google.com.gt","google.com.hk","google.com.jm","google.com.kh","google.com.kw","google.com.lb","google.com.lc","google.com.ly","google.com.mm","google.com.mt","google.com.mx","google.com.my","google.com.na","google.com.nf","google.com.ng","google.com.ni","google.com.np","google.com.om","google.com.pa","google.com.pe","google.com.pg","google.com.ph","google.com.pk","google.com.pr","google.com.py","google.com.qa","google.com.sa","google.com.sb","google.com.sg","google.com.sl","google.com.sv","google.com.tj","google.com.tr","google.com.tw","google.com.ua","google.com.uy","google.com.vc","google.com.vn","google.cv","google.cz","google.de","google.dj","google.dk","google.dm","google.dz","google.ee","google.es","google.fi","google.fm","google.fr","google.ga","google.ge","google.gf","google.gg","google.gl","google.gm","google.gp","google.gr","google.gy","google.hn","google.hr","google.ht","google.hu","google.ie","google.im","google.io","google.iq","google.is","google.it","google.je","google.jo","google.kg","google.ki","google.kz","google.la","google.li","google.lk","google.lt","google.lu","google.lv","google.md","google.me","google.mg","google.mk","google.ml","google.mn","google.ms","google.mu","google.mv","google.mw","google.ne","google.nl","google.no","google.nr","google.nu","google.pl","google.pn","google.ps","google.pt","google.ro","google.rs","google.ru","google.rw","google.sc","google.se","google.sh","google.si","google.sk","google.sm","google.sn","google.so","google.sr","google.st","google.td","google.tg","google.tk","google.tl","google.tm","google.tn","google.to","google.tt","google.vg","google.vu","google.ws"];var y="2.1.6";var x="New Bing Anywhere (Bing Chat GPT-4)";var w=(e=location.hostname)=>I.includes(e.replace(/^www\./,""));var z=()=>{try{return chrome.i18n.getUILanguage().toLowerCase()==="zh-cn"}catch{return!1}},M=()=>{try{let e=chrome.i18n.getUILanguage().toLowerCase();return e==="zh-cn"||e==="zh-tw"||e==="zh-hk"||e==="zh"}catch{return!1}};var v="configV1",p=async()=>({showGoogleButtonOnBing:!0,showBingButtonOnGoogle:!0,showGuideToGithub:!0,showChat:!0,showRelease:!0,triggerMode:"Always",conversationStyle:"Balanced","X-Forwarded-For":void 0,...(await chrome.storage.sync.get(v))[v]}),N=async e=>{let o=await p();await chrome.storage.sync.set({[v]:{...o,...e}})},L=e=>String(e).replace(/&/g,"&amp;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\//g,"&#x2f;");var h=async(e,o=[])=>await new Promise((s,t)=>{chrome.runtime.sendMessage({method:e,args:[...o]},n=>{!n||n.code!==200?t(n?.msg):s(n.data)})}),Q=(()=>{let e="v1";return{get:async o=>{o=`${e}:${o}`;let{data:s,maxAge:t,lastModified:n}=(await chrome.storage.local.get(o))?.[o]??{};return Date.now()-n>t*1e3?(chrome.storage.local.remove(o),null):s},set:async(o,s,t=1/0)=>{o=`${e}:${o}`,await chrome.storage.local.set({[o]:{data:s,lastModified:Date.now(),maxAge:t}})}}})();var k=navigator.userAgent,G=navigator.userAgentData,Z=k.includes("Macintosh"),X=k.includes("Firefox"),A=k.includes("Edg/"),J=G?.brands.findIndex(e=>e.brand==="Brave")>-1,O=M(),ee=z(),j=!!globalThis.__NBA_isCanary,oe=j?`0.${y}`:y;var b=async e=>{try{return await h("openUrlInSameTab",[{url:e}])}catch{location.href=e}},T={attributes:!0,childList:!0,subtree:!0},C=(e,o=document)=>o.querySelector(e),u=async(e,o=30,s=document)=>await new Promise(t=>{let n=C(e,s);if(n){t(n);return}let c=new MutationObserver((m,i)=>{let g=C(e,s);g&&(i.disconnect(),t(g))});c.observe(document,T),setTimeout(()=>{let m=C(e,s);c.disconnect(),t(m)},o*1e3)});var _=async e=>{if(!A){let t=window.document,n=t.createElement("script");n.src=chrome.runtime.getURL("inject.js"),n.onload=n.remove,t.documentElement.appendChild(n)}let o=document.documentElement.dir==="rtl";if(e(()=>{(async()=>{let{showGuideToGithub:t}=await p();if(!t)return;let n=e("#est_switch");e.trim(n.text())==="\u56FD\u5185\u7248\u56FD\u9645\u7248"&&setTimeout(()=>{let c=e('<a href="https://github.com/haozi/New-Bing-Anywhere/issues/8" title="\u67E5\u770B\u5982\u4F55\u6B63\u786E\u914D\u7F6E\u7F51\u7EDC\u4EE3\u7406" target="_blank" rel="noopener noreferrer nofollow">\u4F9D\u7136\u51FA\u73B0\u56FD\u5185\u7248/\u56FD\u9645\u7248\uFF1F</a>').css({color:"#E89ABE",textShadow:"0.5px 0.1px 1px #58070D",fontSize:"12px",fontWeight:"lighter"}).click(()=>{N({showGuideToGithub:!1})});e("#est_switch").append(c).css("width","auto")},2e3)})()}),!location.href.startsWith("https://www.bing.com/search?"))return;let s=await p();u("#sb_form").then(()=>{if(h("getNotification").then(i=>{if(!i)return;let g=e(document.body),a=e("<div/>").css({width:"100%",height:40,border:"1px solid #590727",background:"#58070d",position:"fixed",top:0,fontSize:"12px",lineHeight:"40px",textAlign:"center",zIndex:99999,whiteSpace:"nowrap",textOverflow:"ellipsis",display:"block !important"}),r=()=>{a.remove(),g.css("padding-top",null)},l=e(`<a style="color:#fff; background:url(${chrome.runtime.getURL("images/bing_32x32.png")}) no-repeat left 0; background-size: 12px; padding-inline-start: 20px" href="${i.html_url}" target="_blank" rel="noopener noreferrer nofollow">${i.title}</a>`).on("click",r),d=e('<a href="#" style="background:#58070d; color:#fff; cursor:pointer;padding: 0 68px 0 18px;position: absolute;right:0" title="no reminder">\u2715</a>').on("click",f=>{f.preventDefault(),confirm("Are you sure never see this notice again?")&&h("hideNotification"),r()});a.append(l).append(d),g.append(a).css("padding-top",40)}),e(document.body).on("click","a.b_logoArea",i=>{e(i.currentTarget).attr("href","/").attr("target","_self")}),!s.showGoogleButtonOnBing)return;let t=e("#sb_form_q"),n=t.val(),c=e(`
      <a href="https://www.google.com/search?q=${encodeURIComponent(L(n))}" target="google" tabindex="10" rel="noopener noreferrer nofollow" title="search with Google">
        <img src="${chrome.runtime.getURL("images/google.png")}" alt="google" style="width: 100%;display: block;">
      </a>`).css({position:"absolute",left:0,top:0,width:"70px",height:"23px",display:"inline-block","z-index":999,transition:"all .3s",transform:`translate3d(${835-(o?925:0)}px, 13px, 0px)`,"will-change":"transform",cursor:"pointer"});e("#sb_form").css("position","relative").prepend(c),c.on("click",async i=>{let g=e(i.currentTarget);i.preventDefault();let a="";a||(a=e.trim(t.val()));let r=`https://www.google.com/search?q=${encodeURIComponent(a)}`;g.attr("href",r),await b(r)}),location.search.includes("showconv=1")&&(c.css("display","none"),setTimeout(()=>{c.css("display","inline-block")},1200));let m=()=>{let i=e("#b-scopeListItem-conv"),g=i.hasClass("b_active");if(g){let a=0;i.offset().left?a=i.offset().left+i.width()+30:a=350,c.css({transform:`translate3d(${a-(o?925:0)}px, 15px, 0)`})}else c.css({transform:`translate3d(${835-(o?925:0)}px, 15px, 0)`});!g&&e(".b_searchboxForm").hasClass("as_rsform")&&c.css({transform:`translate3d(${1155-(o?-99999:0)}px, 15px, 0)`})};m(),new MutationObserver((i,g)=>{for(let a of i){let r=a.target;r&&(r.id==="b-scopeListItem-conv"&&m(),r.classList.contains("b_searchboxForm")&&m())}}).observe(document.getElementById("b_header"),T)})};var D=w(),S=async(e,o)=>{let s="",t="",n="",c=location.hostname;D&&(s=new URLSearchParams(location.search).get("q")??"",t=document.documentElement.dir,n=document.querySelector('meta[name="color-scheme"]')?.content==="dark"?"dark":"");let m=new URLSearchParams(location.hash.slice(1)).get("new-bing-anywhere")??"",i={prompt:s.trim(),dir:t,darkmode:n,domain:c,extra:m},g=r=>{for(let l in r)r.hasOwnProperty(l)&&(r[l]||delete r[l]);return new URLSearchParams(r).toString()},a=chrome.runtime.getURL(`/app/index.html#/chat/iframe?${g(i)}`);try{let r=e(`<iframe src="${a}" scrolling="no" />`);r.css({width:"100%",border:"none",overflow:"hidden",boxSizing:"border-box",willChange:"height",transition:"height .1s cubic-bezier(0, 0, 0, 1.27) 0s",borderRadius:"8px"}),window.addEventListener("message",R=>{let{type:P,data:E}=R.data;if(P!=="nba-resize")return;let{height:$}=E;r.css({height:$})});let l;l=e(await u("#rhs",1)),l.length||(l=e('<div id="rhs" />').css({marginInlineStart:"var(--rhs-margin)",flex:"0 auto",width:"var(--rhs-width)",position:"relative",paddingBottom:"15px",transition:"opacity 0.3s"}));let d=e(await u(".liYKde.g.VjDLd",.1));d.length?d.prepend(r):l.prepend(r);let f=await u("#center_col");l.insertAfter(f),e(f).after(l)}catch{}};var U=async e=>{if(!(await p()).showBingButtonOnGoogle||location.pathname!=="/search")return;let s=document.documentElement.dir==="rtl";u('[action="/search"]').then(t=>{if(!t)return;let n=e(t),c=n.find('[name="q"]'),m=n.find('button[type="submit"]'),i=e(`
      <a href="https://www.bing.com/search?q=Bing+AI&showconv=1" rel="noopener noreferrer nofollow" target="bing" title="search with New Bing">
        <img src="${chrome.runtime.getURL("images/bing-chat.png")}" style="display: block; width: 20px; height: 20px" alt="bing" />
      </a>`).css({width:"40px",display:"flex",position:"relative","z-index":999,cursor:"pointer","justify-content":"center","align-items":"center",margin:"-2px 10px 0 -10px",...s?{marginInlineStart:"-10px",marginInlineEnd:"10px"}:null});m.after(i),i.on("click",async g=>{let a=e(g.currentTarget);g.preventDefault();let r=`https://www.bing.com/search?q=${encodeURIComponent(c.val())}&showconv=1`;a.attr("href",r),await b(r)})})};(async e=>{let o=e(document.documentElement);if(o.find(`meta[name="${x}"]`).length)return;let s=e(`<meta name="${x}" />`);o.prepend(s),h("getEnv").then(t=>{s.attr("content",t.version)}),p().then(t=>{t.showChat&&S(e,t)}),location.hostname==="www.bing.com"&&_(e),w()&&U(e)})(window.Zepto);})();
